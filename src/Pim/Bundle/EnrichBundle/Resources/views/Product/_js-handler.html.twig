<script type="text/javascript">
    require(
        [
            'jquery',
            'underscore',
            'pim/optionform',
            'pim/scopable',
            'pim/currencyfield',
            'datepicker',
            'pim/dialog',
            'pim/dialogform',
            'oro/mediator',
            'pim/datagrid/state',
            'backbone/bootstrap-modal',
            'jquery.select2',
            'tinymce'
        ],
        function ($, _, optionform, Scopable, CurrencyField, datepicker, Dialog, DialogForm, mediator, stateManager) {
            'use strict';

            $(function () {
                _.each($('a.add-attribute-option'), function(optionLink) {
                    optionform.init('#' + optionLink.getAttribute('id'));
                });

                var initialScope = '{{ app.user.catalogScope.code }}';
                var datagridFilters = stateManager.getParsed('product-grid', 'filters')
                if (null != datagridFilters && undefined != datagridFilters.f && undefined != datagridFilters.f.scope) {
                    initialScope = datagridFilters.f.scope;
                }

                _.each($('form div.scopable:not(.currency)'), function (field) {
                    new Scopable({ el: $(field), initialScope: initialScope });
                });

                _.each($('form div.currency'), function (field) {
                    new CurrencyField({ el: $(field) });
                });

                _.each($('form input.datepicker:not(.hasPicker)'), function (field) {
                    datepicker.init(field.getAttribute('id'));
                });

                mediator.trigger('pim:reinit');

                // submit form
                $('div.submit-form a').click(function() {
                    var action = $(this).attr('value');
                    $('#{{ form.vars.id }}').attr('action', $('#{{ form.vars.id }}').attr('action') +"&action="+ action);
                    tinymce.triggerSave();
                    $('#{{ form.vars.id }}').submit();
                });

                {% if createPopin is not null %}
                    // create popin if needed
                    new DialogForm('#create-product');
                    $('#create-product').click();
                {% endif %}

                {{ view_elements('pim_enrich_product_edit.after_form_init') }}
            });
        }
    );
</script>
